name: NATS testsuite
vars:
  url: 'nats://localhost:4222'
  baseSubject: "nats.test"
  message: '{"message": "hello world"}'

testcases:

  - name: NATS publish testcase
    steps:
      - type: nats
        url: "{{.url}}"
        command: publish
        subject: "{{.baseSubject}}.publish"
        payload: '{{.message}}'
        headers:
          timestamp:
            - "{{.venom.timestamp}}"
        assertions:
          - result.error ShouldBeEmpty
  
  - name: NATS publish empty subject testcase
    steps:
      - type: nats
        url: "{{.url}}"
        command: publish
        subject: ""
        payload: '{{.message}}'
        headers:
          timestamp:
            - "{{.venom.timestamp}}"
        assertions:
          - result.error ShouldNotBeEmpty

  - name: NATS publish Jetstream testcase
    steps:
      - type: exec
        script: |
          nats stream create TEST --subjects "{{.baseSubject}}.js.>" --defaults

      - type: nats
        command: publish
        subject: "{{.baseSubject}}.js.hello"
        deadline: 2
        jetstream:
          enabled: true
        assertions:
          - result.error ShouldBeEmpty

      - type: exec
        script: |
          nats stream rm TEST -f

  - name: NATS publish Jetstream non-stream subject testcase
    steps:
      - type: exec
        script: |
          nats stream create TEST --subjects "{{.baseSubject}}.js.>" --defaults

      - type: nats
        command: publish
        subject: "some.other.subject"
        deadline: 2
        jetstream:
          enabled: true
        assertions:
          - result.error ShouldNotBeEmpty

      - type: exec
        script: |
          nats stream rm TEST -f

  - name: NATS publish Jetstream empty subject testcase
    steps:
      - type: exec
        script: |
          nats stream create TEST --subjects "{{.baseSubject}}.js.>" --defaults

      - type: nats
        command: publish
        subject: ""
        deadline: 2
        jetstream:
          enabled: true
        assertions:
          - result.error ShouldNotBeEmpty

      - type: exec
        script: |
          nats stream rm TEST -f

  - name: NATS subscribe Jetstream consumer testcase
    steps:
    - type: exec
      script: |
        nats stream create TEST --subjects "{{.baseSubject}}.js.>" --defaults
   
    - type: exec
      script: |
        nats pub "{{.baseSubject}}.js.hello" '{{.message}}'
        nats pub --count 3 "{{.baseSubject}}.js.world" '{{.message}}'
    
    - type: nats
      command: subscribe
      subject: "{{.baseSubject}}.>"
      messageLimit: 2
      deadline: 10
      jetstream:
        enabled: true
        stream: TEST
        filterSubjects:
          - "{{.baseSubject}}.js.hello"
          - "{{.baseSubject}}.js.world"
      assertions:
        - result.error ShouldBeEmpty
        - result.messages.__Len__ ShouldEqual 2

    - type: exec
      script: |
        nats stream rm TEST -f

  - name: NATS subscribe testcase with deadline
    steps:
      - type: nats
        url: "{{.url}}"
        command: subscribe
        subject: "{{.baseSubject}}.>"
        messageLimit: 1
        deadline: 1
        assertions:
          - result.error ShouldNotBeEmpty
          - result.error ShouldContainSubstring "timeout reached"

  - name: NATS request/reply testcase
    steps:
      - type: nats
        url: "{{.url}}"
        command: publish
        request: true
        subject: "{{.baseSubject}}.request"
        replySubject: "{{.baseSubject}}.reply"
        payload: '{{.message}}'
        assertions:
          - result.error ShouldBeEmpty
          - result.messages.__Len__ ShouldEqual 1